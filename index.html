<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°ç‹¼éšŠ PlayType æ¯æ—¥è¿½è¹¤ (Cloud Only)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        window.isCloudEnabled = false;
        window.db = null;
        window.firebaseModules = null;
        window.firebaseError = null; // å„²å­˜éŒ¯èª¤ç‰©ä»¶
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // =================================================================
        //  è¨­å®šå€ï¼šwolves-traker
        // =================================================================
const firebaseConfig = {
    apiKey: "AIzaSyA3b09cIAwNnxBMLinKMP3sOP5ORR4xwo8",
    authDomain: "wolves-traker.firebaseapp.com",
    projectId: "wolves-traker",
    storageBucket: "wolves-traker.firebasestorage.app",
    messagingSenderId: "711518203108",
    appId: "1:711518203108:web:26c7f17065cfec5eaed0f1"
  };
        // =================================================================

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            window.db = getFirestore(app);
            window.firebaseModules = { collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy };
            
            signInAnonymously(auth).then(() => {
                console.log("âœ… Firebase é€£ç·šæˆåŠŸ (åŒ¿åç™»å…¥)");
                window.isCloudEnabled = true;
                window.firebaseError = null;
                window.dispatchEvent(new Event('firebase-ready'));
            }).catch(e => {
                console.warn("Firebase ç™»å…¥å¤±æ•—:", e);
                window.firebaseError = e;
                window.dispatchEvent(new Event('firebase-error'));
                const errLog = document.getElementById('error-log');
                if(errLog) {
                    errLog.style.display = 'block';
                    errLog.innerText = "é€£ç·šå¤±æ•—: " + e.code + "\n(è«‹é»æ“Šå·¦ä¸Šè§’ No Conn æŸ¥çœ‹è©³æƒ…)";
                }
            });
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
            window.firebaseError = e;
        }
    </script>

    <style>
        body { background-color: #020617; color: white; font-family: sans-serif; }
        #loading-screen { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid #1e293b; border-top-color: #78BE20; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .chart-dot:hover { r: 6; stroke-width: 3; cursor: pointer; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #94a3b8; font-size: 0.9rem;">æ­£åœ¨é€£ç·šè‡³é›²ç«¯è³‡æ–™åº«...</p>
        <p id="error-log" style="margin-top: 10px; color: #ef4444; font-size: 0.8rem; white-space: pre-wrap; text-align: center; display: none;"></p>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        // åš´æ ¼æ¨¡å¼ä¸‹ï¼Œä¸ä½¿ç”¨é è¼‰æ•¸æ“šï¼Œå¼·åˆ¶ç­‰å¾… Firebase
        const PRELOADED_DATA = [];

        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-log');
            if(el) { el.style.display = 'block'; el.innerText = "ç³»çµ±åµæ¸¬åˆ°éŒ¯èª¤:\n" + message; }
        };

        const { useState, useEffect, useMemo } = React;

        // Icons
        const Icons = {
            ArrowUp: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>,
            ArrowDown: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></svg>,
            Minus: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/></svg>,
            Database: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Trash2: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            PlusCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            Activity: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Clipboard: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
            ExternalLink: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
            Zap: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            ChevronLeft: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
            Calendar: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Users: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            User: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Bug: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>,
            Eraser: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>,
            Download: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Save: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Shield: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>,
            Sword: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>,
            Lock: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            BarChart: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Cloud: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.2-2.3-2.2-4-4.5-4-2.1 0-3.9 1.5-4.4 3.6C2.6 15.8 1 17.7 1 20c0 2.2 1.8 4 4 4h12.5c2.5 0 4.5-2 4.5-4.5s-2-4.5-4.5-4.5z"/></svg>,
            Code: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>,
            AlertCircle: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        };

        const PlayTypesList = ["Transition", "Isolation", "PRBallHandler", "PRRollMan", "Postup", "Spotup", "Handoff", "Cut", "OffScreen", "OffRebound", "Misc"];
        const KEY_PLAYERS = ["Anthony Edwards", "Julius Randle", "Rudy Gobert", "Jaden McDaniels", "Naz Reid", "Donte DiVincenzo", "Mike Conley", "Rob Dillingham", "Terrence Shannon Jr.", "Joan Beringer", "Bones Hyland", "Joe Ingles", "Leonard Miller", "Jaylen Clark", "Johnny Juzang", "Rocco Zikarsky", "Enrique Freeman"];
        const PLAYER_IDS = {"Anthony Edwards": "1630162", "Julius Randle": "203944", "Rudy Gobert": "203497", "Jaden McDaniels": "1630183", "Naz Reid": "1629675", "Donte DiVincenzo": "1628978", "Mike Conley": "201144", "Rob Dillingham": "1642265", "Terrence Shannon Jr.": "1642275", "Bones Hyland": "1630691", "Joe Ingles": "204060", "Leonard Miller": "1631165", "Jaylen Clark": "1631115", "Johnny Juzang": "1630548", "Enrique Freeman": "1642278"};

        // --- BOOKMARKLETS ---
        const TEAM_BOOKMARKLET = `javascript:(async function(){const t=["Transition","Isolation","PRBallHandler","PRRollMan","Postup","Spotup","Handoff","Cut","OffScreen","OffRebound","Misc"],s=["offensive","defensive"],e=1610612750,a="2025-26",n=[];console.log("Starting Wolves Team Fetch (Off+Def)...");const o=document.createElement("div");o.style.cssText="position:fixed;top:20px;right:20px;z-index:99999;background:#1a202c;color:white;padding:15px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);font-family:sans-serif;width:300px;border:1px solid #4a5568",o.innerHTML='<h3 style="margin:0 0 10px;color:#78BE20">ğŸº ç°ç‹¼ [æ”»å®ˆ] æ•¸æ“šæŠ“å–ä¸­...</h3><div id="prog" style="height:4px;background:#2d3748;width:100%;margin-bottom:10px"><div id="bar" style="height:100%;background:#78BE20;width:0%"></div></div><div id="status" style="font-size:12px;color:#a0aec0">æ­£åœ¨åˆå§‹åŒ–...</div>',document.body.appendChild(o);const d=document.getElementById("bar"),r=document.getElementById("status");let c=0;const l=t.length*2;for(const i of s)for(const p of t){c++;if(i==="defensive"&&(p==="Cut"||p==="Misc")){continue}r.innerText="æŠ“å–: "+p+" ("+(i==="offensive"?"é€²æ”»":"é˜²å®ˆ")+")",d.style.width=c/l*100+"%";try{const t=\`https://stats.nba.com/stats/synergyplaytypes?LeagueID=00&PerMode=PerGame&PlayType=\${p}&PlayerOrTeam=T&SeasonType=Regular%20Season&SeasonYear=\${a}&TypeGrouping=\${i}\`,o=await fetch(t),d=await o.json(),r=d.resultSets[0].headers,f=d.resultSets[0].rowSet.find(t=>t[r.indexOf("TEAM_ID")]==e);f?n.push({playType:p,side:i,poss:f[r.indexOf("POSS")],freq:(100*f[r.indexOf("POSS_PCT")]).toFixed(1),ppp:f[r.indexOf("PPP")].toFixed(2),fgPct:(100*f[r.indexOf("FG_PCT")]).toFixed(1),percentile:(100*f[r.indexOf("PERCENTILE")]).toFixed(1)}):console.warn("No data: "+p),await new Promise(t=>setTimeout(t,500))}catch(t){console.error(t)}}o.innerHTML='<h3 style="margin:0 0 10px;color:#78BE20">âœ… æ•¸æ“šæŠ“å–å®Œæˆï¼</h3><textarea id="jsonres" style="width:100%;height:100px;background:#2d3748;border:1px solid #4a5568;color:#cbd5e0;font-size:11px;margin-bottom:10px"></textarea><button id="closebtn" style="width:100%;padding:8px;background:#78BE20;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:#0C2340">é—œé–‰è¦–çª—</button>';const p=document.getElementById("jsonres");p.value=JSON.stringify({dataType:"TEAM",data:n}),p.select();try{document.execCommand("copy"),r.innerText="å·²è‡ªå‹•è¤‡è£½ï¼"}catch(t){}document.getElementById("closebtn").onclick=()=>document.body.removeChild(o)})();`;
        const PLAYER_BOOKMARKLET = `javascript:(async function(){const t=["Transition","Isolation","PRBallHandler","PRRollMan","Postup","Spotup","Handoff","Cut","OffScreen","OffRebound","Misc"],s=["offensive","defensive"],e=1610612750,a="2025-26",n=[];console.log("Starting Wolves Player Fetch (Off+Def)...");const o=document.createElement("div");o.style.cssText="position:fixed;top:20px;right:20px;z-index:99999;background:#1a202c;color:white;padding:15px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.5);font-family:sans-serif;width:300px;border:1px solid #4a5568",o.innerHTML='<h3 style="margin:0 0 10px;color:#236192">ğŸ‘¤ ç°ç‹¼ [çƒå“¡æ”»å®ˆ] æŠ“å–ä¸­...</h3><div id="prog" style="height:4px;background:#2d3748;width:100%;margin-bottom:10px"><div id="bar" style="height:100%;background:#236192;width:0%"></div></div><div id="status" style="font-size:12px;color:#a0aec0">é€™éœ€è¦ä¸€é»æ™‚é–“ (ç´„20ç§’)...</div>',document.body.appendChild(o);const d=document.getElementById("bar"),r=document.getElementById("status");let c=0;const l=t.length*2;for(const i of s)for(const p of t){c++;if(i==="defensive"&&(p==="Cut"||p==="Misc")){continue}r.innerText="æŠ“å–: "+p+" ("+(i==="offensive"?"é€²æ”»":"é˜²å®ˆ")+")",d.style.width=c/l*100+"%";try{const t=\`https://stats.nba.com/stats/synergyplaytypes?LeagueID=00&PerMode=PerGame&PlayType=\${p}&PlayerOrTeam=P&SeasonType=Regular%20Season&SeasonYear=\${a}&TypeGrouping=\${i}\`,o=await fetch(t),d=await o.json(),f=d.resultSets[0].headers,u=d.resultSets[0].rowSet.filter(t=>t[f.indexOf("TEAM_ID")]==e);u.forEach(t=>{n.push({playType:p,side:i,playerName:t[f.indexOf("PLAYER_NAME")],playerId:t[f.indexOf("PLAYER_ID")],poss:t[f.indexOf("POSS")],freq:(100*t[f.indexOf("POSS_PCT")]).toFixed(1),ppp:t[f.indexOf("PPP")].toFixed(2),fgPct:(100*t[f.indexOf("FG_PCT")]).toFixed(1),percentile:(100*t[f.indexOf("PERCENTILE")]).toFixed(1)})}),await new Promise(t=>setTimeout(t,500))}catch(t){console.error(t)}}o.innerHTML='<h3 style="margin:0 0 10px;color:#236192">âœ… çƒå“¡æ•¸æ“šæŠ“å–å®Œæˆï¼</h3><textarea id="jsonres" style="width:100%;height:100px;background:#2d3748;border:1px solid #4a5568;color:#cbd5e0;font-size:11px;margin-bottom:10px"></textarea><button id="closebtn" style="width:100%;padding:8px;background:#236192;border:none;border-radius:4px;cursor:pointer;font-weight:bold;color:white">é—œé–‰è¦–çª—</button>';const p=document.getElementById("jsonres");p.value=JSON.stringify({dataType:"PLAYER",data:n}),p.select();try{document.execCommand("copy"),r.innerText="å·²è‡ªå‹•è¤‡è£½ï¼"}catch(t){}document.getElementById("closebtn").onclick=()=>document.body.removeChild(o)})();`;

        // Components
        const TrendValue = ({ value, prevValue, unit = "", label, reverseColor = false }) => {
            const diff = prevValue ? (value - prevValue).toFixed(1) : 0;
            const numDiff = parseFloat(diff);
            let colorClass = "text-white"; let Icon = null;
            if (prevValue) {
                if (numDiff > 0) { colorClass = reverseColor ? "text-red-400" : "text-green-400"; Icon = Icons.ArrowUp; } 
                else if (numDiff < 0) { colorClass = reverseColor ? "text-green-400" : "text-red-400"; Icon = Icons.ArrowDown; } 
                else { colorClass = "text-slate-400"; Icon = Icons.Minus; }
            }
            return (<div><span className="block text-slate-500">{label}</span><div className="flex items-center gap-1"><span className={`font-mono text-sm font-bold ${colorClass}`}>{value}{unit}</span>{Icon && <Icon className={`w-3 h-3 ${colorClass}`} />}</div></div>);
        };

        const SimpleLineChart = ({ data, dataKey, color = "#78BE20" }) => {
            if (!data || data.length < 2) return <div className="h-40 flex items-center justify-center text-slate-500 text-xs">æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•ç¹ªè£½è¶¨å‹¢åœ–</div>;
            const height = 150; const width = 500; const padding = 20; const paddingLeft = 40;
            const values = data.map(d => parseFloat(d.stat[dataKey]));
            const min = Math.min(...values); const max = Math.max(...values);
            const range = max - min || 1; const buffer = range * 0.1;
            const domainMin = min - buffer; const domainMax = max + buffer; const domainRange = domainMax - domainMin;
            const points = values.map((val, index) => { const x = paddingLeft + (index / (values.length - 1)) * (width - paddingLeft - padding); const y = height - padding - ((val - domainMin) / domainRange) * (height - 2 * padding); return `${x},${y}`; }).join(' ');
            const ticks = []; const numTicks = 5; for (let i = 0; i < numTicks; i++) { const val = domainMin + (domainRange * i) / (numTicks - 1); const y = height - padding - (i / (numTicks - 1)) * (height - 2 * padding); ticks.push({ val, y }); }
            return (<div className="w-full overflow-hidden mb-4 bg-slate-900/50 rounded-lg p-2 border border-slate-800"><svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full">{ticks.map((tick, i) => (<g key={i}><line x1={paddingLeft} y1={tick.y} x2={width - padding} y2={tick.y} stroke="#334155" strokeWidth="1" strokeDasharray="4" opacity="0.5" /><text x={paddingLeft - 5} y={tick.y + 3} textAnchor="end" fill="#64748b" fontSize="10" fontFamily="monospace">{tick.val.toFixed(2)}</text></g>))}<polyline fill="none" stroke={color} strokeWidth="3" points={points} />{values.map((val, index) => { const x = paddingLeft + (index / (values.length - 1)) * (width - paddingLeft - padding); const y = height - padding - ((val - domainMin) / domainRange) * (height - 2 * padding); return (<g key={index} className="group"><circle cx={x} cy={y} r="4" fill="#0f172a" stroke={color} strokeWidth="2" className="chart-dot transition-all duration-200" /><rect x={x - 15} y={y - 25} width="30" height="16" rx="4" fill="#000" className="opacity-0 group-hover:opacity-100 transition-opacity" /><text x={x} y={y - 13} textAnchor="middle" fill="white" fontSize="10" className="opacity-0 group-hover:opacity-100 transition-opacity font-mono font-bold pointer-events-none">{val}</text><text x={x} y={height - 5} textAnchor="middle" fill="#64748b" fontSize="9">{data[index].date.slice(5).replace('-','/')}</text></g>); })}</svg></div>);
        };

        const App = () => {
            const [teamHistory, setTeamHistory] = useState(PRELOADED_DATA && PRELOADED_DATA.length > 0 ? PRELOADED_DATA : []);
            const [playerHistory, setPlayerHistory] = useState([]);
            const [jsonInput, setJsonInput] = useState('');
            const [showInputModal, setShowInputModal] = useState(false);
            const [inputMode, setInputMode] = useState('team_tool');
            const [copySuccess, setCopySuccess] = useState(false);
            const [viewMode, setViewMode] = useState('TEAM');
            const [viewSide, setViewSide] = useState('offensive');
            const [selectedPlayer, setSelectedPlayer] = useState(KEY_PLAYERS[0]);
            const [viewIndex, setViewIndex] = useState(0);
            const [selectedPlayType, setSelectedPlayType] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loginPassword, setLoginPassword] = useState('');
            const [isCloud, setIsCloud] = useState(window.isCloudEnabled);

            // ç§»é™¤è¼‰å…¥ç•«é¢ & ç›£è½ Cloud ç‹€æ…‹
            useEffect(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => loadingScreen.remove(), 500);
                }

                const handleCloudReady = () => setIsCloud(true);
                const handleCloudError = () => { /* User clicks diagnostics */ };
                window.addEventListener('firebase-ready', handleCloudReady);
                window.addEventListener('firebase-error', handleCloudError);
                
                if (window.isCloudEnabled) setIsCloud(true);
                return () => {
                    window.removeEventListener('firebase-ready', handleCloudReady);
                    window.removeEventListener('firebase-error', handleCloudError);
                };
            }, []);

            // Init & Sync Logic - FIX: Re-run when isCloud changes
            useEffect(() => {
                if (isCloud && window.db && window.firebaseModules) {
                    const { collection, onSnapshot, query, orderBy } = window.firebaseModules;
                    
                    const unsubTeam = onSnapshot(query(collection(window.db, "wolves_team_stats"), orderBy("date", "desc")), (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ ...doc.data(), date: doc.id }));
                        if(data.length > 0) setTeamHistory(data);
                    });
                    
                    const unsubPlayer = onSnapshot(query(collection(window.db, "wolves_player_stats"), orderBy("date", "desc")), (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ ...doc.data(), date: doc.id }));
                        if(data.length > 0) setPlayerHistory(data);
                    });

                    return () => {
                        unsubTeam();
                        unsubPlayer();
                    };
                }
            }, [isCloud]);

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { if (document.execCommand('copy')) { setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000); } } catch (err) {}
                document.body.removeChild(textArea);
            };

            const isDuplicate = (newStats, lastStats) => {
                if (!lastStats) return false;
                const sortStats = (s) => [...s].sort((a, b) => (a.playType + a.side).localeCompare(b.playType + b.side));
                return JSON.stringify(sortStats(newStats)) === JSON.stringify(sortStats(lastStats));
            };

            const saveDataToFirebase = async (collectionName, date, data) => {
                if (!window.db) { alert("å°šæœªé€£ç·šåˆ° Firebaseï¼Œç„¡æ³•å„²å­˜ã€‚"); return false; }
                const { doc, setDoc } = window.firebaseModules;
                try {
                    await setDoc(doc(window.db, collectionName, date), { stats: data, timestamp: Date.now() });
                    alert("âœ… æ•¸æ“šå·²æˆåŠŸåŒæ­¥è‡³é›²ç«¯ï¼");
                    return true;
                } catch (e) {
                    console.error("Write Error", e);
                    alert("å¯«å…¥å¤±æ•—ï¼š" + e.message);
                    return false;
                }
            };

            // åŒ¯å‡ºå‚™ä»½ (JSONä¸‹è¼‰)
            const handleExport = () => {
                const data = {
                    team: teamHistory,
                    player: playerHistory,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wolves_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // åŒ¯å…¥å‚™ä»½ (è®€å–JSON)
            const handleImportBackup = () => {
                if (!jsonInput.trim()) return alert("è«‹è²¼ä¸Šå‚™ä»½ JSON å…§å®¹");
                try {
                    const parsed = JSON.parse(jsonInput);
                    if (!parsed.team || !parsed.player) throw new Error("æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° team æˆ– player æ•¸æ“š");
                    
                    if (confirm(`ç¢ºå®šè¦é‚„åŸå‚™ä»½å—ï¼Ÿ\né€™å°‡è¦†è“‹ç›®å‰çš„æ•¸æ“šã€‚\n\nå‚™ä»½æ—¥æœŸ: ${parsed.exportDate || 'æœªçŸ¥'}`)) {
                        // Migration logic inside restore
                        const teamData = parsed.team.map(entry => ({
                            ...entry,
                            stats: entry.stats.map(s => ({ ...s, side: s.side || 'offensive' }))
                        }));
                        const playerData = parsed.player.map(entry => {
                            const newStats = {};
                            Object.keys(entry.stats).forEach(player => {
                                newStats[player] = entry.stats[player].map(s => ({ ...s, side: s.side || 'offensive' }));
                            });
                            return { ...entry, stats: newStats };
                        });

                        setTeamHistory(teamData);
                        setPlayerHistory(playerData);
                        alert("âœ… æ•¸æ“šé‚„åŸæˆåŠŸï¼(æ³¨æ„ï¼šè‹¥è™•æ–¼ Cloud æ¨¡å¼ï¼Œæ­¤é‚„åŸåƒ…æš«å­˜æ–¼è¨˜æ†¶é«”ï¼Œé‡æ–°æ•´ç†å¾Œå°‡é‡æ–°è¼‰å…¥é›²ç«¯æ•¸æ“š)");
                        setShowInputModal(false);
                        setJsonInput('');
                        setViewIndex(0);
                    }
                } catch (e) {
                    alert("é‚„åŸå¤±æ•—ï¼š" + e.message);
                }
            };

            const handleAddData = async () => {
                const today = new Date().toISOString().split('T')[0];
                if (!jsonInput.trim()) return alert("è«‹è²¼ä¸Šæ•¸æ“š");
                
                // Strict Cloud Mode Check
                if (!window.isCloudEnabled) {
                    alert("éŒ¯èª¤ï¼šå°šæœªé€£ç·šè‡³é›²ç«¯è³‡æ–™åº«ï¼Œç„¡æ³•å„²å­˜æ•¸æ“šã€‚");
                    return;
                }

                try {
                    const parsed = JSON.parse(jsonInput);
                    
                    // --- TEAM DATA ---
                    if (parsed.dataType === "TEAM" || (Array.isArray(parsed) && !parsed[0].playerName)) {
                        const data = parsed.dataType ? parsed.data : parsed;
                        const enrichedData = data.map(item => ({...item, side: item.side || 'offensive'}));
                        
                        if (teamHistory.length > 0 && isDuplicate(enrichedData, teamHistory[0].stats)) {
                            alert("âš ï¸ å®˜ç¶²æ•¸æ“šå°šæœªæ›´æ–°ï¼\n\næª¢æ¸¬åˆ°æ‚¨åŒ¯å…¥çš„æ•¸æ“šèˆ‡è³‡æ–™åº«æœ€æ–°ç´€éŒ„å®Œå…¨ç›¸åŒã€‚\nç‚ºäº†ä¸å½±éŸ¿è¶¨å‹¢åœ–è¡¨ï¼Œæœ¬æ¬¡åŒ¯å…¥å·²å–æ¶ˆã€‚");
                            return;
                        }

                        await saveDataToFirebase("wolves_team_stats", today, enrichedData);

                    // --- PLAYER DATA ---
                    } else if (parsed.dataType === "PLAYER" || (Array.isArray(parsed) && parsed[0].playerName)) {
                        const data = parsed.dataType ? parsed.data : parsed;
                        const playerStatsMap = {};
                        data.forEach(row => {
                            if (!playerStatsMap[row.playerName]) playerStatsMap[row.playerName] = [];
                            playerStatsMap[row.playerName].push({...row, side: row.side || 'offensive'});
                        });

                        // Duplicate Check (Player - Sample Check with Ant)
                        if (playerHistory.length > 0) {
                            const lastEntry = playerHistory[0];
                            const keyPlayer = "Anthony Edwards";
                            if (lastEntry.stats[keyPlayer] && playerStatsMap[keyPlayer]) {
                                if (isDuplicate(playerStatsMap[keyPlayer], lastEntry.stats[keyPlayer])) {
                                     alert("âš ï¸ å®˜ç¶²æ•¸æ“šå°šæœªæ›´æ–°ï¼\n\næª¢æ¸¬åˆ°çƒå“¡æ•¸æ“š (ä»¥ Anthony Edwards ç‚ºä¾‹) èˆ‡è³‡æ–™åº«ç´€éŒ„ç›¸åŒã€‚\næœ¬æ¬¡åŒ¯å…¥å·²å–æ¶ˆã€‚");
                                     return;
                                }
                            }
                        }

                        await saveDataToFirebase("wolves_player_stats", today, playerStatsMap);

                    } else { throw new Error("ç„¡æ³•è­˜åˆ¥æ•¸æ“šæ ¼å¼"); }
                    
                    setJsonInput(''); setShowInputModal(false); setViewIndex(0);
                } catch (e) { alert("è§£æå¤±æ•—ï¼š" + e.message); }
            };

            const clearHistory = async (type) => { 
                if(type === 'ALL' && confirm("é€™å°‡åˆªé™¤é›²ç«¯æ‰€æœ‰æ­·å²ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ")) { 
                    if (!window.db) return alert("ç„¡é›²ç«¯é€£ç·š");
                    alert("æ³¨æ„ï¼šåœ¨åš´æ ¼é›²ç«¯æ¨¡å¼ä¸‹ï¼Œæ¸…ç©ºæ•´å€‹è³‡æ–™åº«éœ€è¦é€é Firebase Console æ“ä½œä»¥ç¢ºä¿å®‰å…¨ã€‚");
                } 
            };
            const handleLogin = () => { if (loginPassword === 'yen76wolfherd') { setIsAuthenticated(true); setLoginPassword(''); } else { alert('å¯†ç¢¼éŒ¯èª¤'); } };
            const generateReleaseCode = () => { copyToClipboard(JSON.stringify(teamHistory)); alert("å·²è¤‡è£½ä»£ç¢¼"); };
            const handleSimulation = (type, days=1) => { /* Disabled in Strict Cloud Mode to avoid pollution or confusion */ alert("åš´æ ¼é›²ç«¯æ¨¡å¼ä¸‹å·²åœç”¨æ¨¡æ“¬åŠŸèƒ½ã€‚"); };
            const clearSimulation = () => { /* Disabled */ };
            
            // è¨ºæ–·æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            const handleStatusClick = () => {
                if (!isCloud) {
                    if (window.firebaseError) {
                        const code = window.firebaseError.code;
                        let tip = "";
                        if (code === 'auth/unauthorized-domain') {
                            tip = "ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š\nè«‹åˆ° Firebase Console -> Authentication -> Settings -> Authorized Domainsï¼Œå°‡æ‚¨çš„ GitHub ç¶²å€åŠ å…¥ç™½åå–®ã€‚";
                        } else if (code === 'auth/operation-not-allowed') {
                            tip = "ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š\nè«‹åˆ° Firebase Console -> Authentication -> Sign-in methodï¼Œå°‡ 'Anonymous' (åŒ¿å) è¨­ç‚ºå•Ÿç”¨ã€‚";
                        } else if (code === 'auth/api-key-not-valid.-please-pass-a-valid-api-key.') {
                             tip = "ğŸ’¡ è§£æ±ºæ–¹æ³•ï¼š\næ‚¨çš„ API Key ä¼¼ä¹ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ index.html ä¸­çš„ firebaseConfig æ˜¯å¦å¡«å¯«æ­£ç¢ºã€‚";
                        }
                        alert(`ğŸ”´ é€£ç·šå¤±æ•—\n\néŒ¯èª¤ä»£ç¢¼: ${code}\néŒ¯èª¤è¨Šæ¯: ${window.firebaseError.message}\n\n${tip}`);
                    } else {
                        alert("ğŸ”´ é€£ç·šå¤±æ•—ï¼š\n\nå°šæœªæ”¶åˆ° Firebase å›æ‡‰ã€‚è«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯ï¼Œæˆ–æŒ‰ä¸‹ F12 æŸ¥çœ‹ Console æ˜¯å¦æœ‰ç´…å­—éŒ¯èª¤ã€‚");
                    }
                } else {
                    alert("ğŸ”µ é€£ç·šæ­£å¸¸ï¼š\n\nå·²æˆåŠŸé€£ç·šè‡³ Firestore è³‡æ–™åº«ã€‚");
                }
            };
            
            // ... (View Logic Same) ...
            let currentStats = []; let prevStats = []; let displayDate = "å°šç„¡æ•¸æ“š"; let currentPlayerId = null;
            if (viewMode === 'TEAM') {
                const current = teamHistory[viewIndex]; const prev = teamHistory[viewIndex + 1];
                if (current) { currentStats = current.stats; displayDate = current.date; }
                if (prev) { prevStats = prev.stats; }
            } else {
                const current = playerHistory[viewIndex]; const prev = playerHistory[viewIndex + 1];
                if (current && current.stats[selectedPlayer]) {
                    currentStats = current.stats[selectedPlayer]; displayDate = current.date;
                    if(currentStats.length > 0 && currentStats[0].playerId) currentPlayerId = currentStats[0].playerId;
                }
                if (prev && prev.stats[selectedPlayer]) { prevStats = prev.stats[selectedPlayer]; }
                if (!currentPlayerId) currentPlayerId = PLAYER_IDS[selectedPlayer];
            }
            const maxIndex = (viewMode === 'TEAM' ? teamHistory.length : playerHistory.length) - 1;
            const goPrev = () => { if (viewIndex < maxIndex) setViewIndex(viewIndex + 1); };
            const goNext = () => { if (viewIndex > 0) setViewIndex(viewIndex - 1); };

            const StatCard = ({ type, current, prev, onClick, side }) => {
                if (!current) return null;
                const diffPPP = prev ? (current.ppp - prev.ppp).toFixed(2) : 0;
                const isDefensive = side === 'defensive';
                let isBetter = false; let isWorse = false;
                if (prev) {
                    const numDiff = parseFloat(diffPPP);
                    if (isDefensive) { if (numDiff < 0) isBetter = true; else if (numDiff > 0) isWorse = true; } 
                    else { if (numDiff > 0) isBetter = true; else if (numDiff < 0) isWorse = true; }
                }
                let bgColor = "bg-slate-800", borderColor = "border-slate-700";
                if (prev) {
                    if (isBetter) { borderColor = "border-green-500/50"; bgColor = "bg-gradient-to-br from-slate-800 to-green-900/30"; }
                    else if (isWorse) { borderColor = "border-red-500/50"; bgColor = "bg-gradient-to-br from-slate-800 to-red-900/30"; }
                }
                return (
                    <div onClick={() => onClick(type)} className={`p-4 rounded-xl border ${borderColor} ${bgColor} shadow-lg relative overflow-hidden cursor-pointer hover:scale-[1.02] transition-transform group`}>
                        <div className="absolute top-0 right-0 p-4 opacity-5 text-slate-400 font-black text-4xl pointer-events-none select-none">{type.substring(0, 2)}</div>
                        <div className="flex justify-between items-start mb-2 relative z-10">
                            <h3 className="text-xs font-bold text-slate-300 uppercase tracking-wider truncate" title={type}>{type}</h3>
                            <div className="text-slate-500 text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">è©³æƒ… <Icons.ExternalLink className="w-3 h-3"/></div>
                        </div>
                        <div className="flex items-baseline gap-2 mb-4 relative z-10">
                            <span className={`text-3xl font-extrabold ${isBetter ? 'text-green-400' : isWorse ? 'text-red-400' : 'text-white'}`}>{current.ppp}</span>
                            <span className="text-xs text-slate-500 font-medium">PPP</span>
                            {prev && (<div className={`flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold ml-auto ${isBetter ? 'bg-green-500/20 text-green-400' : isWorse ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-slate-400'}`}>{isBetter ? <Icons.ArrowUp className="w-3 h-3 mr-1"/> : isWorse ? <Icons.ArrowDown className="w-3 h-3 mr-1"/> : <Icons.Minus className="w-3 h-3 mr-1"/>} {Math.abs(diffPPP)}</div>)}
                        </div>
                        <div className="grid grid-cols-2 gap-y-3 gap-x-2 text-[10px] border-t border-slate-700/50 pt-3 relative z-10 bg-slate-900/30 rounded p-2">
                            <TrendValue label="Percentile" value={current.percentile} prevValue={prev?.percentile} unit="th" />
                            <TrendValue label="FG%" value={current.fgPct} prevValue={prev?.fgPct} unit="%" reverseColor={isDefensive} />
                            <TrendValue label="Freq%" value={current.freq} prevValue={prev?.freq} unit="%" />
                            <TrendValue label="Poss" value={current.poss} prevValue={prev?.poss} />
                        </div>
                    </div>
                );
            };

            const HistoryModal = ({ playType, onClose }) => {
                const [chartMetric, setChartMetric] = useState(null); 
                const targetHistory = viewMode === 'TEAM' ? teamHistory : playerHistory;
                const recentStats = targetHistory
                    .map(entry => {
                        let stat;
                        if (viewMode === 'TEAM') stat = entry.stats.find(s => s.playType === playType && (s.side || 'offensive') === viewSide);
                        else stat = entry.stats[selectedPlayer]?.find(s => s.playType === playType && (s.side || 'offensive') === viewSide);
                        return { date: entry.date, stat };
                    })
                    .filter(item => item.stat)
                    .slice(0, 10);
                const chartData = [...recentStats].reverse();
                const isDefensive = viewSide === 'defensive';
                const toggleChart = (metric) => { if (chartMetric === metric) setChartMetric(null); else setChartMetric(metric); };
                return (
                    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                        <div className="bg-slate-950 rounded-2xl border border-slate-700 w-full max-w-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
                            <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 shrink-0">
                                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                    <span className={`w-8 h-8 rounded flex items-center justify-center text-sm ${isDefensive ? 'bg-red-900/50 text-red-200' : 'bg-[#236192] text-white'}`}>{playType?.substring(0,2)}</span>
                                    {viewMode === 'PLAYER' ? selectedPlayer : 'çƒéšŠ'} - {playType} ({isDefensive ? 'é˜²å®ˆ' : 'é€²æ”»'})
                                </h3>
                                <button onClick={onClose} className="text-slate-400 hover:text-white"><Icons.X /></button>
                            </div>
                            <div className="p-4 bg-slate-900/50 border-b border-slate-800">
                                <p className="text-xs text-slate-400 mb-2 flex items-center gap-2"><Icons.BarChart className="w-3 h-3"/> é»æ“Šä¸‹æ–¹æ¬„ä½æ¨™é¡Œå¯åˆ‡æ›æŠ˜ç·šåœ–ï¼š</p>
                                {chartMetric && (<div className="mb-4 fade-in"><h4 className="text-xs font-bold text-white mb-2 uppercase tracking-wider">{chartMetric} èµ°å‹¢åœ– (è¿‘10å ´)</h4><SimpleLineChart data={chartData} dataKey={chartMetric} color={isDefensive && (chartMetric === 'ppp' || chartMetric === 'fgPct') ? '#ef4444' : '#78BE20'} /></div>)}
                            </div>
                            <div className="p-0 overflow-y-auto">
                                <table className="w-full text-left text-sm text-slate-400"><thead className="bg-slate-900/50 text-xs uppercase font-bold text-slate-500 sticky top-0"><tr><th className="px-6 py-3">æ—¥æœŸ</th><th className={`px-6 py-3 cursor-pointer hover:text-white transition-colors select-none ${chartMetric === 'ppp' ? 'text-white border-b-2 border-[#78BE20]' : ''}`} onClick={() => toggleChart('ppp')}>PPP</th><th className={`px-6 py-3 cursor-pointer hover:text-white transition-colors select-none ${chartMetric === 'fgPct' ? 'text-white border-b-2 border-[#78BE20]' : ''}`} onClick={() => toggleChart('fgPct')}>FG%</th><th className={`px-6 py-3 cursor-pointer hover:text-white transition-colors select-none ${chartMetric === 'percentile' ? 'text-white border-b-2 border-[#78BE20]' : ''}`} onClick={() => toggleChart('percentile')}>Percentile</th><th className={`px-6 py-3 cursor-pointer hover:text-white transition-colors select-none ${chartMetric === 'poss' ? 'text-white border-b-2 border-[#78BE20]' : ''}`} onClick={() => toggleChart('poss')}>Poss</th></tr></thead>
                                    <tbody className="divide-y divide-slate-800">{recentStats.map((item, idx) => { const prevItem = recentStats[idx + 1]; const pppDiff = prevItem ? (item.stat.ppp - prevItem.stat.ppp).toFixed(2) : 0; let isGood = false; let isBad = false; const numDiff = parseFloat(pppDiff); if (prevItem) { if (isDefensive) { if (numDiff < 0) isGood = true; else if (numDiff > 0) isBad = true; } else { if (numDiff > 0) isGood = true; else if (numDiff < 0) isBad = true; } } return (<tr key={item.date} className="hover:bg-slate-900/50 transition-colors"><td className="px-6 py-4 font-mono text-slate-300">{item.date}</td><td className="px-6 py-4"><div className="flex items-center gap-2"><span className={`font-bold font-mono text-lg ${isGood ? 'text-green-400' : isBad ? 'text-red-400' : 'text-white'}`}>{item.stat.ppp}</span>{prevItem && (isGood ? <Icons.ArrowUp className="w-3 h-3 text-green-500"/> : isBad ? <Icons.ArrowDown className="w-3 h-3 text-red-500"/> : <Icons.Minus className="w-3 h-3 text-slate-600"/>)}</div></td><td className="px-6 py-4 font-mono">{item.stat.fgPct}%</td><td className="px-6 py-4 font-mono">{item.stat.percentile}th</td><td className="px-6 py-4 font-mono">{item.stat.poss}</td></tr>); })}</tbody></table>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans pb-20">
                    <header className="sticky top-0 z-20 bg-slate-900/80 backdrop-blur-md border-b border-slate-800 p-4 shadow-md">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-full bg-[#0C2340] border-2 border-[#78BE20] flex items-center justify-center overflow-hidden shadow-lg"><img src="https://i.imgur.com/HSY3cX7.png" alt="Timberwolves Logo" className="w-full h-full object-cover" /></div><div><h1 className="text-xl font-bold text-white tracking-tight">Timberwolves PlayType</h1><p className="text-xs text-[#78BE20] font-medium tracking-wide cursor-pointer hover:underline" onClick={handleStatusClick} title="é»æ“ŠæŸ¥çœ‹é€£ç·šè©³æƒ…">DAILY TRACKER {isCloud ? <span className="text-blue-400 ml-2 font-bold animate-pulse">â€¢ Cloud</span> : <span className="text-red-500 ml-2">â€¢ No Conn</span>}</p></div>
                            </div>
                            <div className="flex items-center gap-2"><a href="https://www.nba.com/stats/team/1610612750/onoffcourt-traditional" target="_blank" rel="noreferrer" className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-medium transition-colors border border-slate-700"><Icons.ExternalLink className="w-4 h-4" /> Team Info</a><button onClick={() => setShowInputModal(true)} className="flex items-center gap-2 px-4 py-2 bg-[#236192] hover:bg-[#1a4a70] text-white rounded-lg text-sm font-bold transition-all shadow-lg active:scale-95"><Icons.PlusCircle className="w-4 h-4" /> <span className="hidden sm:inline">åŒ¯å…¥æ•¸æ“š</span><span className="sm:hidden">åŒ¯å…¥</span></button></div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        <div className="grid md:grid-cols-4 gap-6">
                            <div className="md:col-span-1 space-y-4">
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 space-y-4">
                                    <div className="flex gap-2 bg-slate-950 p-1 rounded-lg border border-slate-800"><button onClick={() => { setViewMode('TEAM'); setViewIndex(0); }} className={`flex-1 py-2 text-sm font-bold rounded transition-colors flex items-center justify-center gap-2 ${viewMode === 'TEAM' ? 'bg-[#236192] text-white shadow' : 'text-slate-400 hover:text-white'}`}><Icons.Users className="w-4 h-4" /> çƒéšŠ</button><button onClick={() => { setViewMode('PLAYER'); setViewIndex(0); }} className={`flex-1 py-2 text-sm font-bold rounded transition-colors flex items-center justify-center gap-2 ${viewMode === 'PLAYER' ? 'bg-[#236192] text-white shadow' : 'text-slate-400 hover:text-white'}`}><Icons.User className="w-4 h-4" /> çƒå“¡</button></div>
                                    <div className="flex gap-2 bg-slate-950 p-1 rounded-lg border border-slate-800"><button onClick={() => setViewSide('offensive')} className={`flex-1 py-2 text-sm font-bold rounded transition-colors flex items-center justify-center gap-2 ${viewSide === 'offensive' ? 'bg-[#78BE20] text-[#0C2340] shadow' : 'text-slate-400 hover:text-white'}`}><Icons.Sword className="w-4 h-4" /> é€²æ”»</button><button onClick={() => setViewSide('defensive')} className={`flex-1 py-2 text-sm font-bold rounded transition-colors flex items-center justify-center gap-2 ${viewSide === 'defensive' ? 'bg-red-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Icons.Shield className="w-4 h-4" /> é˜²å®ˆ</button></div>
                                    {viewMode === 'PLAYER' && (<div className="space-y-2"><h3 className="text-xs font-bold text-slate-500 uppercase">é¸æ“‡çƒå“¡</h3><div className="grid grid-cols-1 gap-1">{KEY_PLAYERS.map(player => (<button key={player} onClick={() => { setSelectedPlayer(player); setViewIndex(0); }} className={`text-left px-3 py-2 rounded text-sm font-medium transition-colors ${selectedPlayer === player ? 'bg-[#78BE20] text-[#0C2340] font-bold' : 'text-slate-300 hover:bg-slate-800'}`}>{player}</button>))}</div></div>)}
                                </div>
                            </div>
                            <div className="md:col-span-3 space-y-6">
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4">
                                    <div className="flex items-center gap-2"><h2 className="text-xl font-bold text-white flex items-center gap-2">{viewMode === 'TEAM' ? 'ç°ç‹¼éšŠ' : selectedPlayer}<span className={`${viewSide === 'defensive' ? 'text-red-400' : 'text-[#78BE20]'}`}>{viewSide === 'defensive' ? 'é˜²å®ˆè¡¨ç¾' : 'é€²æ”»è¡¨ç¾'}</span></h2>{viewMode === 'PLAYER' && currentPlayerId && (<a href={`https://www.nba.com/player/${currentPlayerId}`} target="_blank" rel="noreferrer" className="ml-2 px-3 py-1 bg-slate-800 hover:bg-slate-700 text-xs font-bold text-slate-300 rounded border border-slate-600 flex items-center gap-1 transition-colors" title="å‰å¾€ NBA å®˜ç¶²çƒå“¡é é¢">Player Profile <Icons.ExternalLink className="w-3 h-3"/></a>)}</div>
                                    <div className="flex items-center gap-3 bg-slate-950 p-1 rounded-lg border border-slate-800"><button onClick={goPrev} disabled={viewIndex >= maxIndex} className="p-2 rounded hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed text-slate-400"><Icons.ChevronLeft className="w-4 h-4" /></button><div className="px-4 py-1 border-x border-slate-800 flex items-center gap-2 min-w-[140px] justify-center"><Icons.Calendar className="w-4 h-4 text-[#78BE20]" /><span className="text-white font-mono font-bold">{displayDate}</span></div><button onClick={goNext} disabled={viewIndex === 0} className="p-2 rounded hover:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed text-slate-400"><Icons.ChevronRight className="w-4 h-4" /></button></div>
                                </div>
                                {currentStats && currentStats.length > 0 ? (<div className="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 fade-in">{PlayTypesList.map(type => { const stat = currentStats.find(s => s.playType === type && (s.side || 'offensive') === viewSide); const prevStat = prevStats ? prevStats.find(s => s.playType === type && (s.side || 'offensive') === viewSide) : null; if (!stat) return null; return (<StatCard key={type} type={type} current={stat} prev={prevStat} onClick={setSelectedPlayType} side={viewSide} />); })}</div>) : (<div className="text-center py-20 bg-slate-900/30 rounded-2xl border border-slate-800 border-dashed"><Icons.Database className="mx-auto text-slate-600 mb-4 w-12 h-12" /><h3 className="text-xl text-slate-300 font-medium">å°šç„¡ {viewSide === 'defensive' ? 'é˜²å®ˆ' : 'é€²æ”»'} æ•¸æ“š</h3><p className="text-slate-500 mt-2 mb-6">{viewSide === 'defensive' ? 'è«‹æ›´æ–°æ•¸æ“šå°æ›¸ç±¤ä»¥æŠ“å–é˜²å®ˆè³‡æ–™ï¼ŒèˆŠæ•¸æ“šåƒ…åŒ…å«é€²æ”»ç«¯ã€‚' : 'è«‹åŒ¯å…¥æ•¸æ“šã€‚'}</p></div>)}
                            </div>
                        </div>
                    </main>
                    {selectedPlayType && <HistoryModal playType={selectedPlayType} onClose={() => setSelectedPlayType(null)} />}
                    {showInputModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                            <div className="bg-slate-950 rounded-2xl border border-slate-700 w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-900 shrink-0"><h3 className="text-lg font-bold text-white flex items-center gap-2"><Icons.Database className="text-[#236192] w-5 h-5"/> åŒ¯å…¥æ•¸æ“š (Cloud Only)</h3><button onClick={() => { setShowInputModal(false); setIsAuthenticated(false); setLoginPassword(''); }} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button></div>
                                {!isAuthenticated ? (
                                    <div className="p-10 flex flex-col items-center justify-center space-y-4"><div className="bg-slate-900 p-6 rounded-xl border border-slate-700 w-full max-w-sm text-center shadow-lg"><div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-700"><Icons.Lock className="w-8 h-8 text-yellow-500" /></div><h3 className="text-white font-bold mb-4">ç®¡ç†å“¡æ¬Šé™é©—è­‰</h3><p className="text-xs text-slate-400 mb-6">ç‚ºé˜²æ­¢æ•¸æ“šèª¤åˆªï¼Œè«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥ç¹¼çºŒã€‚</p><input type="password" className="w-full bg-slate-950 border border-slate-600 rounded-lg p-3 text-sm text-white mb-4 focus:outline-none focus:border-yellow-500 text-center" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" value={loginPassword} onChange={(e) => setLoginPassword(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleLogin()} /><button onClick={handleLogin} className="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition-colors">é©—è­‰èº«åˆ†</button></div></div>
                                ) : (
                                    <>
                                        <div className="flex border-b border-slate-800 shrink-0"><button onClick={() => setInputMode('team_tool')} className={`flex-1 py-3 text-sm font-bold transition-colors ${inputMode === 'team_tool' ? 'text-[#78BE20] border-b-2 border-[#78BE20] bg-slate-900' : 'text-slate-500 hover:text-slate-300'}`}>çƒéšŠæ•¸æ“š</button><button onClick={() => setInputMode('player_tool')} className={`flex-1 py-3 text-sm font-bold transition-colors ${inputMode === 'player_tool' ? 'text-[#236192] border-b-2 border-[#236192] bg-slate-900' : 'text-slate-500 hover:text-slate-300'}`}>çƒå“¡æ•¸æ“š</button><button onClick={() => setInputMode('backup')} className={`flex-1 py-3 text-sm font-bold transition-colors ${inputMode === 'backup' ? 'text-yellow-500 border-b-2 border-yellow-500 bg-slate-900' : 'text-slate-500 hover:text-slate-300'}`}>å‚™ä»½/é‚„åŸ</button><button onClick={() => setInputMode('publish')} className={`flex-1 py-3 text-sm font-bold transition-colors ${inputMode === 'publish' ? 'text-purple-400 border-b-2 border-purple-400 bg-slate-900' : 'text-slate-500 hover:text-slate-300'}`}>ç™¼å¸ƒå·¥å…·</button><button onClick={() => setInputMode('debug')} className={`flex-1 py-3 text-sm font-bold transition-colors ${inputMode === 'debug' ? 'text-red-400 border-b-2 border-red-400 bg-slate-900' : 'text-slate-500 hover:text-slate-300'}`}>æ¸¬è©¦/æ¸…ç©º</button></div>
                                        <div className="p-6 overflow-y-auto space-y-6">
                                            {inputMode === 'publish' ? (
                                                <div className="space-y-4">
                                                    <div className="bg-purple-900/20 p-4 rounded-xl border border-purple-800/50"><h4 className="text-purple-400 font-bold mb-2 flex items-center gap-2"><Icons.Code className="w-4 h-4"/> ç¶²ç«™ç™¼å¸ƒä»£ç¢¼ç”¢ç”Ÿå™¨</h4><p className="text-xs text-slate-400 mb-4">è‹¥æ‚¨è¦å°‡æ•¸æ“šç™¼å¸ƒåˆ° GitHub Pagesï¼Œè«‹è¤‡è£½æ­¤ä»£ç¢¼ä¸¦å–ä»£ HTML æª”æ¡ˆæœ€ä¸Šæ–¹çš„ <code>PRELOADED_DATA</code>ã€‚</p><button onClick={generateReleaseCode} className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><Icons.Clipboard className="w-4 h-4"/> è¤‡è£½å®Œæ•´è³‡æ–™åº«ä»£ç¢¼</button></div>
                                                </div>
                                            ) : inputMode === 'debug' ? (
                                                <div className="space-y-4"><div className="bg-red-900/20 p-4 rounded-xl border border-red-900/50"><h4 className="text-red-400 font-bold mb-2 flex items-center gap-2"><Icons.Bug className="w-4 h-4"/> æ¸¬è©¦èˆ‡æ¸…ç©º</h4><p className="text-xs text-slate-400 mb-4">åš´æ ¼é›²ç«¯æ¨¡å¼ä¸‹å·²åœç”¨æ¨¡æ“¬åŠŸèƒ½ã€‚</p><div className="space-y-2"><button onClick={() => clearHistory('ALL')} className="w-full py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-bold rounded transition-colors flex items-center justify-center gap-2"><Icons.Trash2 className="w-4 h-4"/> æ¸…ç©ºé›²ç«¯è³‡æ–™åº« (éœ€æ‰‹å‹•ç¢ºèª)</button></div></div></div>
                                            ) : inputMode === 'backup' ? (
                                                <div className="space-y-6">
                                                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800">
                                                        <h4 className="text-white font-bold mb-2 flex items-center gap-2"><Icons.Download className="w-4 h-4 text-green-400"/> åŒ¯å‡ºè³‡æ–™ (å‚™ä»½)</h4>
                                                        <p className="text-xs text-slate-400 mb-3">å°‡ç›®å‰çš„çƒéšŠèˆ‡çƒå“¡æ•¸æ“šä¸‹è¼‰ç‚º JSON æª”æ¡ˆï¼Œä»¥ä¾›å‚™ä»½æˆ–è½‰ç§»è‡³ Google Siteã€‚</p>
                                                        <button onClick={handleExport} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg border border-slate-700 transition-colors flex items-center justify-center gap-2">
                                                            <Icons.Save className="w-4 h-4"/> ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ
                                                        </button>
                                                    </div>

                                                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800">
                                                        <h4 className="text-white font-bold mb-2 flex items-center gap-2"><Icons.Upload className="w-4 h-4 text-blue-400"/> é‚„åŸè³‡æ–™</h4>
                                                        <p className="text-xs text-slate-400 mb-3">è«‹å°‡å‚™ä»½æª”æ¡ˆ (.json) çš„å…§å®¹è¤‡è£½ä¸¦è²¼åœ¨ä¸‹æ–¹ã€‚</p>
                                                        <textarea className="w-full h-32 bg-slate-950 border border-slate-800 rounded-lg p-3 text-xs font-mono text-slate-300 focus:outline-none focus:border-blue-500 mb-3" placeholder='{"team": [...], "player": [...]}' value={jsonInput} onChange={(e) => setJsonInput(e.target.value)}></textarea>
                                                        <button onClick={handleImportBackup} className="w-full py-3 bg-[#236192] hover:bg-[#1a4a70] text-white font-bold rounded-lg transition-colors flex items-center justify-center gap-2">
                                                            <Icons.Upload className="w-4 h-4"/> é‚„åŸæ•¸æ“š
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                /* Team/Player Tool section (same as before) */
                                                <>
                                                    <div className="bg-slate-900 p-4 rounded-xl border border-slate-800"><h4 className="text-white font-bold mb-2 flex items-center gap-2"><span className="w-5 h-5 rounded-full bg-slate-700 text-xs flex items-center justify-center">1</span>{inputMode === 'team_tool' ? 'çƒéšŠ (å«æ”»å®ˆ)' : 'çƒå“¡ (å«æ”»å®ˆ)'} æ•¸æ“šå°æ›¸ç±¤</h4><p className="text-xs text-slate-400 mb-3">è«‹è¤‡è£½ä¸‹æ–¹æ›´æ–°å¾Œçš„ä»£ç¢¼ (v4.3) ä¸¦æ›´æ–°æ‚¨çš„æ›¸ç±¤ã€‚</p><div className="relative"><div className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-[10px] text-slate-500 font-mono truncate select-all">{inputMode === 'team_tool' ? TEAM_BOOKMARKLET : PLAYER_BOOKMARKLET}</div><button onClick={() => copyToClipboard(inputMode === 'team_tool' ? TEAM_BOOKMARKLET : PLAYER_BOOKMARKLET)} className="absolute right-1 top-1 px-2 py-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded flex items-center gap-1 transition-colors">{copySuccess ? 'å·²è¤‡è£½ï¼' : <><Icons.Clipboard className="w-3 h-3"/> è¤‡è£½</>}</button></div></div>
                                                    <div className="space-y-2"><h4 className="text-white font-bold flex items-center gap-2"><span className="w-5 h-5 rounded-full bg-slate-700 text-xs flex items-center justify-center">2</span> è²¼ä¸Šæ•¸æ“š</h4><textarea className="w-full h-24 bg-slate-950 border border-slate-800 rounded-lg p-3 text-xs font-mono text-slate-300 focus:outline-none focus:border-[#78BE20]" placeholder="è«‹è²¼ä¸Šå°æ›¸ç±¤æŠ“å–çš„ JSON..." value={jsonInput} onChange={(e) => setJsonInput(e.target.value)}></textarea><button onClick={handleAddData} className="w-full py-3 bg-[#78BE20] hover:bg-[#6aa81c] text-[#0C2340] font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><Icons.Zap className="w-4 h-4"/> è§£æä¸¦åŒ¯å…¥ (Cloud Sync)</button></div>
                                                </>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

